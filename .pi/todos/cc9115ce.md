{
  "id": "cc9115ce",
  "title": "[P2] Add thread-safety to PhalaCluster shared state",
  "tags": [
    "pr-3",
    "concurrency",
    "p2",
    "phala"
  ],
  "status": "open",
  "created_at": "2026-02-16T10:17:05.898Z"
}

**File:** `model_orchestrator/infrastructure/phala/_cluster.py`

`task_client_map`, `cvms`, and `head_id` are mutated by `register_task`, `_provision_new_runner`, and `rebuild_task_map`, and read by `client_for_task`, `head_client`, etc. The orchestrator runs polling and model management in separate threads.

While CPython's GIL protects individual dict operations, compound operations like `ensure_capacity` (read count → decide → provision → update head) can race. `PhalaMetrics` correctly uses a threading.Lock — `PhalaCluster` should too, at least around `_provision_new_runner` and `ensure_capacity`.
