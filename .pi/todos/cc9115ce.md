{
  "id": "cc9115ce",
  "title": "[P2] Add thread-safety to PhalaCluster shared state",
  "tags": [
    "pr-3",
    "concurrency",
    "p2",
    "phala"
  ],
  "status": "done",
  "created_at": "2026-02-16T10:17:05.898Z"
}

**File:** `model_orchestrator/infrastructure/phala/_cluster.py`

Added `threading.Lock` (`self._lock`) to protect shared mutable state (`cvms`, `head_id`, `task_client_map`).

**Locked methods:**
- `ensure_capacity()` — holds lock for entire check→decide→provision sequence to prevent two threads from simultaneously deciding to provision
- `_provision_new_runner()` — called within `ensure_capacity`'s lock
- `register_task()` — single dict write
- `rebuild_task_map()` — delegates to `_rebuild_task_map_unlocked()` under lock
- `head_client()` — reads `head_id` + `cvms`
- `client_for_task()` — reads `task_client_map` + `cvms`
- `all_clients()` — snapshot of `cvms`
