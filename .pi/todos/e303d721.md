{
  "id": "e303d721",
  "title": "[P1] Guard against empty node_name producing invalid URL after provisioning",
  "tags": [
    "pr-3",
    "bug",
    "p1",
    "phala"
  ],
  "status": "open",
  "created_at": "2026-02-16T10:16:41.730Z"
}

**File:** `model_orchestrator/infrastructure/phala/_cluster.py`, lines 536–541

If `_get_node_name()` returns `""` (API down, CVM not yet visible), the `url_template` becomes `https://<id>-<model-port>.dstack-pha-.phala.network` — an invalid hostname. The code then busy-waits for 3 minutes trying to health-check this broken URL before raising an error.

**Fix:** Add an early check after `_get_node_name`:

```python
node_name = self._get_node_name(new_app_id)
if not node_name:
    raise PhalaClusterError(
        f"CVM {cvm_name} deployed (app_id={new_app_id}) but could not determine node_name from API"
    )
```
